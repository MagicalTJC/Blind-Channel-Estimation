clear all
Nt = 1; %发射天线数
Ntd = 4; %检测阶段发射天线数
Nr =4; %接收天线数
L = 1; %仿真的总帧数
EbN0 =40;
M = 16; %QPSK调制
pilot_len = 0;
N = 20-pilot_len; %每帧的长度
detect_num = 10000; %检测阶段信号长度
standard_signal = (0:1:M-1);
source_signal = randi([0,M-1],N*L,Nt); %信源数据
source_detect_signal = randi([0,M-1],detect_num*L,Ntd); %检测阶段信源数据
%trans_signal = pskmod(source_signal,M,pi/4); %QPSK调制
%detect_trans_signal = pskmod(source_detect_signal,M,pi/4);   %检测阶段传输的信号
detect_trans_signal = qammod(source_detect_signal,M);
trans_signal = [0+1j];
sound_trans_signal = repmat(trans_signal,(N+pilot_len)/4,1);
trans_signal = [0+1j];

htttest1 = [0.905602544663450 + 1.79987416635470i,0.145984637838993 + 0.496947901640766i,0.234748494378100 + 0.296973350709780i,0.449298674554639 + 0.108383234578052i;
    0.304197752298669 + 0.307983834327902i,0.288473562467569 + 1.108160825149229i,0.941546432293282 + 1.002083567374591i,0.941546432293282 + 1.002083567374591i;
    1.448136537221314 + 0.372051617245618i,0.542406545865309 + 0.693545758206122i,0.031459908664386 + 0.267728507664168i,0.265205451849207 + 0.194930065897175i;
    0.957488906925402 + 0.447836031343800i,1.975601250463709 + 0.321528176547968i,0.720214022544161 + 1.446576270561200i,0.294962345200984 + 0.699538040751152i];

htttest2 = [0.905602544663450 + 1.79987416635470i,0.145984637838993 + 0.496947901640766i,0.234748494378100 + 0.296973350709780i,0.449298674554639 + 0.108383234578052i;
    0.304197752298669 + 0.307983834327902i,0.288473562467569 + 1.108160825149229i,0.941546432293282 + 1.002083567374591i,0.941546432293282 + 1.002083567374591i;
    1.448136537221314 + 0.372051617245618i,0.542406545865309 + 0.693545758206122i,0.031459908664386 + 0.267728507664168i,0.265205451849207 + 0.194930065897175i;
    0.957488906925402 + 0.447836031343800i,1.975601250463709 + 0.321528176547968i,0.720214022544161 + 1.446576270561200i,0.294962345200984 + 0.699538040751152i;0.905602544663450 + 1.79987416635470i,0.145984637838993 + 0.496947901640766i,0.234748494378100 + 0.296973350709780i,0.449298674554639 + 0.108383234578052i;
    0.304197752298669 + 0.307983834327902i,0.288473562467569 + 1.108160825149229i,0.941546432293282 + 1.002083567374591i,0.941546432293282 + 1.002083567374591i;
    1.448136537221314 + 0.372051617245618i,0.542406545865309 + 0.693545758206122i,0.031459908664386 + 0.267728507664168i,0.265205451849207 + 0.194930065897175i;
    0.957488906925402 + 0.447836031343800i,1.975601250463709 + 0.321528176547968i,0.720214022544161 + 1.446576270561200i,0.294962345200984 + 0.699538040751152i;0.905602544663450 + 1.79987416635470i,0.145984637838993 + 0.496947901640766i,0.234748494378100 + 0.296973350709780i,0.449298674554639 + 0.108383234578052i;
    0.304197752298669 + 0.307983834327902i,0.288473562467569 + 1.108160825149229i,0.941546432293282 + 1.002083567374591i,0.941546432293282 + 1.002083567374591i;
    1.448136537221314 + 0.372051617245618i,0.542406545865309 + 0.693545758206122i,0.031459908664386 + 0.267728507664168i,0.265205451849207 + 0.194930065897175i;
    0.957488906925402 + 0.447836031343800i,1.975601250463709 + 0.321528176547968i,0.720214022544161 + 1.446576270561200i,0.294962345200984 + 0.699538040751152i;0.905602544663450 + 1.79987416635470i,0.145984637838993 + 0.496947901640766i,0.234748494378100 + 0.296973350709780i,0.449298674554639 + 0.108383234578052i;
    0.304197752298669 + 0.307983834327902i,0.288473562467569 + 1.108160825149229i,0.941546432293282 + 1.002083567374591i,0.941546432293282 + 1.002083567374591i;
    1.448136537221314 + 0.372051617245618i,0.542406545865309 + 0.693545758206122i,0.031459908664386 + 0.267728507664168i,0.265205451849207 + 0.194930065897175i;
    0.957488906925402 + 0.447836031343800i,1.975601250463709 + 0.321528176547968i,0.720214022544161 + 1.446576270561200i,0.294962345200984 + 0.699538040751152i;0.905602544663450 + 1.79987416635470i,0.145984637838993 + 0.496947901640766i,0.234748494378100 + 0.296973350709780i,0.449298674554639 + 0.108383234578052i;
    0.304197752298669 + 0.307983834327902i,0.288473562467569 + 1.108160825149229i,0.941546432293282 + 1.002083567374591i,0.941546432293282 + 1.002083567374591i;
    1.448136537221314 + 0.372051617245618i,0.542406545865309 + 0.693545758206122i,0.031459908664386 + 0.267728507664168i,0.265205451849207 + 0.194930065897175i;
    0.957488906925402 + 0.447836031343800i,1.975601250463709 + 0.321528176547968i,0.720214022544161 + 1.446576270561200i,0.294962345200984 + 0.699538040751152i;0.905602544663450 + 1.79987416635470i,0.145984637838993 + 0.496947901640766i,0.234748494378100 + 0.296973350709780i,0.449298674554639 + 0.108383234578052i;
    0.304197752298669 + 0.307983834327902i,0.288473562467569 + 1.108160825149229i,0.941546432293282 + 1.002083567374591i,0.941546432293282 + 1.002083567374591i;
    1.448136537221314 + 0.372051617245618i,0.542406545865309 + 0.693545758206122i,0.031459908664386 + 0.267728507664168i,0.265205451849207 + 0.194930065897175i;
    0.957488906925402 + 0.447836031343800i,1.975601250463709 + 0.321528176547968i,0.720214022544161 + 1.446576270561200i,0.294962345200984 + 0.699538040751152i;0.905602544663450 + 1.79987416635470i,0.145984637838993 + 0.496947901640766i,0.234748494378100 + 0.296973350709780i,0.449298674554639 + 0.108383234578052i;
    0.304197752298669 + 0.307983834327902i,0.288473562467569 + 1.108160825149229i,0.941546432293282 + 1.002083567374591i,0.941546432293282 + 1.002083567374591i;
    1.448136537221314 + 0.372051617245618i,0.542406545865309 + 0.693545758206122i,0.031459908664386 + 0.267728507664168i,0.265205451849207 + 0.194930065897175i;
    0.957488906925402 + 0.447836031343800i,1.975601250463709 + 0.321528176547968i,0.720214022544161 + 1.446576270561200i,0.294962345200984 + 0.699538040751152i;0.905602544663450 + 1.79987416635470i,0.145984637838993 + 0.496947901640766i,0.234748494378100 + 0.296973350709780i,0.449298674554639 + 0.108383234578052i;
    0.304197752298669 + 0.307983834327902i,0.288473562467569 + 1.108160825149229i,0.941546432293282 + 1.002083567374591i,0.941546432293282 + 1.002083567374591i;
    1.448136537221314 + 0.372051617245618i,0.542406545865309 + 0.693545758206122i,0.031459908664386 + 0.267728507664168i,0.265205451849207 + 0.194930065897175i;
    0.957488906925402 + 0.447836031343800i,1.975601250463709 + 0.321528176547968i,0.720214022544161 + 1.446576270561200i,0.294962345200984 + 0.699538040751152i;0.905602544663450 + 1.79987416635470i,0.145984637838993 + 0.496947901640766i,0.234748494378100 + 0.296973350709780i,0.449298674554639 + 0.108383234578052i;
    0.304197752298669 + 0.307983834327902i,0.288473562467569 + 1.108160825149229i,0.941546432293282 + 1.002083567374591i,0.941546432293282 + 1.002083567374591i;
    1.448136537221314 + 0.372051617245618i,0.542406545865309 + 0.693545758206122i,0.031459908664386 + 0.267728507664168i,0.265205451849207 + 0.194930065897175i;
    0.957488906925402 + 0.447836031343800i,1.975601250463709 + 0.321528176547968i,0.720214022544161 + 1.446576270561200i,0.294962345200984 + 0.699538040751152i;0.905602544663450 + 1.79987416635470i,0.145984637838993 + 0.496947901640766i,0.234748494378100 + 0.296973350709780i,0.449298674554639 + 0.108383234578052i;
    0.304197752298669 + 0.307983834327902i,0.288473562467569 + 1.108160825149229i,0.941546432293282 + 1.002083567374591i,0.941546432293282 + 1.002083567374591i;
    1.448136537221314 + 0.372051617245618i,0.542406545865309 + 0.693545758206122i,0.031459908664386 + 0.267728507664168i,0.265205451849207 + 0.194930065897175i;
    0.957488906925402 + 0.447836031343800i,1.975601250463709 + 0.321528176547968i,0.720214022544161 + 1.446576270561200i,0.294962345200984 + 0.699538040751152i];
htttest2 = htttest2.';

%ntttest = [0.713891892598110 - 0.275033428361341i,0.359652459975243 + 0.776533040302894i,-0.431147489109728 + 0.187569912804678i,0.252618775641865 + 0.716009983810535i;
   % -0.024910038293094 + 0.048763538333014i,-0.026484249777558 + 0.499902754186239i,0.459903191449179 + 0.589824909712284i,0.031608276935814 - 0.561271227620030i;
    %-0.349855994653059 - 0.334029419264393i,-0.276539703442937 + 0.210313425951162i,0.558490699560117 - 0.091029318296011i,-0.331158630946219 + 0.513769242320757i;
   % 0.012760351992588 - 0.474962673683341i,-0.176113492765854 + 0.347539559425404i,1.084086670727427 + 0.063941389907311i,0.264746347898961 - 0.033648408476365i;
  %  -0.164098007516473 + 0.150658570489739i,-0.643851163674508 + 0.210603388046887i,-0.075995239525815 - 0.185422913246581i,1.279496445220106 - 0.241842411518843i];
sigma1 = sqrt(1/2)*sqrt(1/(10.^(EbN0/10))); %每根接收天线的高斯白噪声标准差
MMSE_diagterm = 2*sigma1.^2*diag(ones(1,4));

sss =[];
QP = [0,1,2,3];
s=zeros(4,4,4,4);
for a=1:4
    for b=1:4
        for c=1:4
            for d=1:4 
                s1 = [QP(a);QP(b);QP(c);QP(d)];
                sss=[sss;s1];
            end
        end
    end
end

sss = reshape(sss,4,1024/4);
MLstan=pskmod(sss',M,pi/4);


%trans_signal = [0-i;0-i;trans_signal];
standard_signal = pskmod(standard_signal,M,pi/4);
user = 4;
sounding_phase_signal = [];
h_test = [];



for index = 1:user
    

    %h_test_temp = abs(randn(Nt,Nr))+j*abs(randn(Nt,Nr));                      %Rayleigh衰落信道
    h_test_temp = htttest1(index,:);
    h_test_temp = h_test_temp./sqrt(2);                                       %信道系数归一化

    h_test = [h_test;h_test_temp];

    n = sigma1*(randn((N+pilot_len)/4,Nr)+1j * randn((N+pilot_len)/4,Nr)); %每根接收天线的高斯白噪声
    sounding_phase_signal_temp = sound_trans_signal * h_test_temp+n;
    %sounding_phase_signal_temp = sound_trans_signal * h_test_temp+ntttest;
    sounding_phase_signal = [sounding_phase_signal;sounding_phase_signal_temp]; 
    
end

RHH = h_test*h_test';

n1 = sigma1*(randn(detect_num,Nr)+1j * randn(detect_num,Nr));
detect_phase_signal = detect_trans_signal * h_test+n1;
%n = sigma1*(randn(256,Nr)+1j * randn(256,Nr));
%detect_phase_signal = MLstan * h_test+n;
received_signal=[sounding_phase_signal;detect_phase_signal];

htttest = [0.905602544663450 + 1.79987416635470i,0.145984637838993 + 0.496947901640766i,0.234748494378100 + 0.296973350709780i,0.449298674554639 + 0.108383234578052i;0.304197752298669 + 0.307983834327902i,0.288473562467569 + 1.108160825149229i,0.941546432293282 + 1.002083567374591i,0.941546432293282 + 1.002083567374591i;1.448136537221314 + 0.372051617245618i,0.542406545865309 + 0.693545758206122i,0.031459908664386 + 0.267728507664168i,0.265205451849207 + 0.194930065897175i;0.957488906925402 + 0.447836031343800i,1.975601250463709 + 0.321528176547968i,0.720214022544161 + 1.446576270561200i,0.294962345200984 + 0.699538040751152i];

save received_signal